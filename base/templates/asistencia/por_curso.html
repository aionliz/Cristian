{% extends "base.html" %}

{% block title %}Asistencia por Curso - Colegio AML{% endblock %}

{% block content %}

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3">
                    <i class="fas fa-users text-primary"></i>
                    Asistencia por Curso
                </h1>
                <a href="{{ url_for('asistencia.index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label for="curso" class="form-label">
                                <i class="fas fa-school"></i> Curso
                            </label>
                            <select class="form-select auto-submit" id="curso" name="curso">
                                <option value="">Seleccione un curso...</option>
                                {% for curso in cursos %}
                                <option value="{{ curso.id_curso }}" {% if curso.id_curso|string==id_curso %}selected{%
                                    endif %}>
                                    {{ curso.nombre_completo }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="fecha" class="form-label">
                                <i class="fas fa-calendar"></i> Fecha
                            </label>
                            <input type="date" class="form-control auto-submit" id="fecha" name="fecha"
                                value="{{ fecha }}">
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                            {% if id_curso %}
                            <!-- Botones de marcaci√≥n -->
                            <div class="btn-group me-2" role="group">
                                <button type="button" class="btn btn-success btn-sm btn-marcar-todos"
                                    data-estado="presente">
                                    <i class="fas fa-check"></i> <small>Presentes</small>
                                </button>
                            </div>

                            <!-- Bot√≥n de marcaci√≥n biom√©trica -->
                            <button type="button" class="btn btn-info btn-sm btn-activar-biometrico"
                                title="Activar sistema biom√©trico">
                                <i class="fas fa-fingerprint"></i> <small>Biom√©trico</small>
                            </button>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {% if id_curso %}
    <!-- Resumen -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center border-0 shadow-sm">
                <div class="card-body">
                    <h3 class="text-success">{{ asistencias|selectattr("estado", "equalto", "presente")|list|length }}
                    </h3>
                    <p class="mb-0 text-muted">Presentes</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-0 shadow-sm">
                <div class="card-body">
                    <h3 class="text-danger">{{ asistencias|selectattr("estado", "equalto", "ausente")|list|length }}
                    </h3>
                    <p class="mb-0 text-muted">Ausentes</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-0 shadow-sm">
                <div class="card-body">
                    <h3 class="text-warning">{{ asistencias|selectattr("estado", "equalto", "tardanza")|list|length }}
                    </h3>
                    <p class="mb-0 text-muted">Atrasados</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-0 shadow-sm">
                <div class="card-body">
                    <h3 class="text-info">{{ alumnos_sin_asistencia|length }}</h3>
                    <p class="mb-0 text-muted">Sin Registro</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de asistencias -->
    {% if asistencias %}
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i>
                        Alumnos con Asistencia Registrada
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Nombre Completo</th>
                                    <th>Estado</th>
                                    <th>Hora Llegada</th>
                                    <th>Observaciones</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for asistencia in asistencias %}
                                <tr>
                                    <td>
                                        <strong>{{ asistencia.nombre }} {{ asistencia.apellido_paterno }} {{
                                            asistencia.apellido_materno }}</strong>
                                    </td>
                                    <td>
                                        {% if asistencia.estado == 'presente' %}
                                        <span style="color: #00cc00 !important; font-weight: bold !important;">
                                            <i class="fas fa-check" style="color: #00cc00 !important;"></i> Presente
                                        </span>
                                        {% elif asistencia.estado == 'ausente' %}
                                        <span style="color: #ff3333 !important; font-weight: bold !important;">
                                            <i class="fas fa-times" style="color: #ff3333 !important;"></i> Ausente
                                        </span>
                                        {% elif asistencia.estado == 'tardanza' %}
                                        <span style="color: #ff9900 !important; font-weight: bold !important;">
                                            <i class="fas fa-clock" style="color: #ff9900 !important;"></i> Atrasado
                                        </span>
                                        {% elif asistencia.estado == 'justificado' %}
                                        <span style="color: #3399ff !important; font-weight: bold !important;">
                                            <i class="fas fa-file-alt" style="color: #3399ff !important;"></i>
                                            Justificado
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ asistencia.hora_llegada|format_time if asistencia.hora_llegada else '-' }}
                                    </td>
                                    <td>
                                        {% if asistencia.observaciones %}
                                        <span title="{{ asistencia.observaciones }}">
                                            {{ asistencia.observaciones[:30] }}{% if asistencia.observaciones|length >
                                            30 %}...{% endif %}
                                        </span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{{ url_for('asistencia.editar_asistencia', id_asistencia=asistencia.id_asistencia) }}"
                                                class="btn btn-outline-primary" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{{ url_for('asistencia.detalle_alumno', id_alumno=asistencia.id_alumno) }}"
                                                class="btn btn-outline-info" title="Ver historial">
                                                <i class="fas fa-history"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Alumnos sin asistencia -->
    {% if alumnos_sin_asistencia %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-warning">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle"></i>
                        Alumnos Sin Registro de Asistencia
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Nombre Completo</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alumno in alumnos_sin_asistencia %}
                                <tr>
                                    <td>
                                        <strong>{{ alumno.nombre }} {{ alumno.apellido_paterno }} {{
                                            alumno.apellido_materno }}</strong>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <!-- Marcaci√≥n manual -->
                                            <button class="btn btn-outline-primary" data-action="marcar-asistencia"
                                                data-alumno-id="{{ alumno.id_alumno }}"
                                                data-alumno-nombre="{{ alumno.nombre|escape }} {{ alumno.apellido_paterno|escape }} {{ alumno.apellido_materno|escape }}"
                                                title="Marcar manualmente">
                                                <i class="fas fa-plus"></i> Manual
                                            </button>
                                            <!-- Marcaci√≥n biom√©trica -->
                                            <button class="btn btn-outline-info btn-marcar-biometrico"
                                                data-alumno-id="{{ alumno.id_alumno }}"
                                                data-alumno-nombre="{{ alumno.nombre|escape }} {{ alumno.apellido_paterno|escape }} {{ alumno.apellido_materno|escape }}"
                                                title="Marcar con huella dactilar">
                                                <i class="fas fa-fingerprint"></i> Huella
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center py-5">
                    <i class="fas fa-school fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Seleccione un curso para ver la asistencia</h5>
                    <p class="text-muted">Use los filtros de arriba para comenzar</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal para marcar asistencia r√°pida -->
<div class="modal fade" id="modalAsistenciaRapida" tabindex="-1" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-check"></i> Marcar Asistencia
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="formAsistenciaRapida">
                    <input type="hidden" id="rapid_id_alumno" name="id_alumno">
                    <input type="hidden" id="rapid_fecha" name="fecha" value="{{ fecha }}">

                    <div class="mb-3">
                        <strong>Alumno:</strong> <span id="rapid_nombre_alumno">-</span>
                    </div>

                    <div class="mb-3">
                        <label for="rapid_estado" class="form-label">Estado</label>
                        <select class="form-select" id="rapid_estado" name="estado" required>
                            <option value="presente" selected>Presente</option>
                            <option value="ausente">Ausente</option>
                            <option value="tardanza">Tardanza</option>
                            <option value="justificado">Justificado</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="rapid_hora_llegada" class="form-label">Hora de Llegada</label>
                        <input type="time" class="form-control" id="rapid_hora_llegada" name="hora_llegada">
                    </div>

                    <div class="mb-3">
                        <label for="rapid_observaciones" class="form-label">Observaciones</label>
                        <textarea class="form-control" id="rapid_observaciones" name="observaciones" rows="2"
                            placeholder="Observaciones adicionales..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success btn-guardar-asistencia-rapida">
                    <i class="fas fa-save"></i> Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Estilo b√°sico para modal si Bootstrap no est√° disponible -->
<style>
    /* Modal base */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1050;
        display: none;
    }

    .modal.show {
        display: block !important;
    }

    .modal-dialog {
        position: relative;
        margin: 5% auto;
        max-width: 500px;
        width: 90%;
    }

    .modal-content {
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Modal header */
    .modal-header {
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #f8f9fa;
        border-radius: 8px 8px 0 0;
    }

    .modal-title {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 500;
        color: #495057;
    }

    .btn-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.25rem;
        color: #6c757d;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
    }

    .btn-close:hover {
        background-color: #e9ecef;
        color: #000;
    }

    /* Modal body */
    .modal-body {
        padding: 1.5rem;
        max-height: 60vh;
        overflow-y: auto;
    }

    /* Modal footer */
    .modal-footer {
        padding: 1rem;
        border-top: 1px solid #dee2e6;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        background-color: #f8f9fa;
        border-radius: 0 0 8px 8px;
    }

    /* Form controls */
    .form-label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: block;
        color: #495057;
    }

    .form-control,
    .form-select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ced4da;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        font-size: 1rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #80bdff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    /* Buttons */
    .btn {
        padding: 0.75rem 1.5rem;
        border: 1px solid transparent;
        border-radius: 6px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        font-weight: 500;
        text-align: center;
        transition: all 0.15s ease-in-out;
        font-size: 1rem;
    }

    .btn-success {
        background-color: #28a745;
        border-color: #28a745;
        color: white;
    }

    .btn-success:hover {
        background-color: #218838;
        border-color: #1e7e34;
    }

    .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #5a6268;
        border-color: #545b62;
    }

    .btn:disabled {
        opacity: 0.65;
        cursor: not-allowed;
    }

    /* Form groups */
    .mb-3 {
        margin-bottom: 1rem;
    }

    /* Body lock */
    .modal-open {
        overflow: hidden;
    }

    /* Responsive */
    @media (max-width: 576px) {
        .modal-dialog {
            margin: 2% auto;
            width: 95%;
        }

        .modal-header,
        .modal-body,
        .modal-footer {
            padding: 1rem;
        }
    }

    /* Backdrop - Deshabilitado para permitir funcionamiento de JS */
    .modal-backdrop {
        display: none !important;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1040;
    }

    .modal-backdrop.show {
        display: none !important;
        opacity: 1;
    }
</style>
<script>
    // Sistema de marcaci√≥n simplificado y robusto
    document.addEventListener('DOMContentLoaded', function () {
        console.log('üöÄ Sistema de marcaci√≥n v2.0 iniciado');

        let modal = null;

        // Funci√≥n principal para mostrar modal
        function showModal(alumnoId, alumnoNombre) {
            console.log('üìù Abriendo modal para:', alumnoNombre, 'ID:', alumnoId);

            modal = document.getElementById('modalAsistenciaRapida');
            if (!modal) {
                alert('Error: Modal no encontrado');
                return;
            }

            // Llenar formulario
            const form = document.getElementById('formAsistenciaRapida');
            if (form) {
                form.querySelector('#rapid_id_alumno').value = alumnoId;
                form.querySelector('#rapid_nombre_alumno').textContent = alumnoNombre;

                // Hora actual
                const now = new Date();
                const time = now.getHours().toString().padStart(2, '0') + ':' +
                    now.getMinutes().toString().padStart(2, '0');
                form.querySelector('#rapid_hora_llegada').value = time;
            }

            // Mostrar modal
            modal.style.display = 'block';
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';

            console.log('‚úÖ Modal abierto');
        }

        // Funci√≥n para cerrar modal
        function closeModal() {
            console.log('üîí Cerrando modal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
                document.body.style.overflow = '';

                // Reset form
                const form = document.getElementById('formAsistenciaRapida');
                if (form) form.reset();
            }
        }

        // Funci√≥n para guardar
        function saveData() {
            console.log('üíæ Guardando datos...');

            const form = document.getElementById('formAsistenciaRapida');
            if (!form) {
                alert('Error: Formulario no encontrado');
                return;
            }

            const formData = new FormData(form);
            const saveBtn = document.querySelector('.btn-guardar-asistencia-rapida');

            // UI feedback
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = 'Guardando...';
            }

            // Enviar
            fetch('/asistencia/marcar', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    console.log('üì° Respuesta:', response.status);
                    if (response.ok || response.status === 302) {
                        alert('‚úÖ Guardado correctamente');
                        closeModal();
                        window.location.reload();
                    } else {
                        alert('‚ùå Error al guardar');
                    }
                })
                .catch(error => {
                    console.error('üö® Error:', error);
                    alert('‚ùå Error de conexi√≥n');
                })
                .finally(() => {
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Guardar';
                    }
                });
        }

        // Funci√≥n para marcaci√≥n masiva
        function marcarTodosMasivo(estado) {
            console.log('üìä Marcaci√≥n masiva:', estado);

            if (!confirm(`¬øEst√°s seguro de marcar a TODOS los alumnos como ${estado}?`)) {
                return;
            }

            // Obtener todos los alumnos sin registro
            const alumnosSinRegistro = document.querySelectorAll('[data-action="marcar-asistencia"]');

            if (alumnosSinRegistro.length === 0) {
                alert('No hay alumnos sin registro para marcar');
                return;
            }

            let procesados = 0;
            let errores = 0;

            const procesarAlumno = async (button) => {
                const alumnoId = button.getAttribute('data-alumno-id');
                const fecha = document.getElementById('rapid_fecha') ? document.getElementById('rapid_fecha').value : '{{ fecha }}';

                const formData = new FormData();
                formData.append('id_alumno', alumnoId);
                formData.append('fecha', fecha);
                formData.append('estado', estado);

                // Hora actual para presentes y atrasados
                if (estado === 'presente' || estado === 'tardanza') {
                    const now = new Date();
                    const time = now.getHours().toString().padStart(2, '0') + ':' +
                        now.getMinutes().toString().padStart(2, '0');
                    formData.append('hora_llegada', time);
                }

                try {
                    const response = await fetch('/asistencia/marcar', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok || response.status === 302) {
                        procesados++;
                    } else {
                        errores++;
                    }
                } catch (error) {
                    console.error('Error procesando alumno:', error);
                    errores++;
                }
            };

            // Procesar todos los alumnos
            Promise.all(Array.from(alumnosSinRegistro).map(procesarAlumno))
                .then(() => {
                    alert(`‚úÖ Proceso completado: ${procesados} marcados, ${errores} errores`);
                    window.location.reload();
                })
                .catch(error => {
                    console.error('Error en marcaci√≥n masiva:', error);
                    alert('‚ùå Error en la marcaci√≥n masiva');
                });
        }

        // Event listeners
        document.addEventListener('click', function (e) {
            // Bot√≥n marcar manual
            const markBtn = e.target.closest('[data-action="marcar-asistencia"]');
            if (markBtn) {
                e.preventDefault();
                const id = markBtn.getAttribute('data-alumno-id');
                const name = markBtn.getAttribute('data-alumno-nombre');
                console.log('üñ±Ô∏è Click marcar:', name, id);
                showModal(id, name);
                return;
            }

            // Botones de marcaci√≥n masiva
            const masiveBtn = e.target.closest('.btn-marcar-todos');
            if (masiveBtn) {
                e.preventDefault();
                const estado = masiveBtn.getAttribute('data-estado');
                console.log('üñ±Ô∏è Click marcaci√≥n masiva:', estado);
                marcarTodosMasivo(estado);
                return;
            }

            // Bot√≥n guardar
            if (e.target.classList.contains('btn-guardar-asistencia-rapida')) {
                e.preventDefault();
                saveData();
                return;
            }

            // Bot√≥n cerrar
            if (e.target.classList.contains('btn-close') ||
                e.target.textContent.trim() === 'Cancelar') {
                e.preventDefault();
                closeModal();
                return;
            }

            // Click fuera del modal
            if (e.target === modal) {
                closeModal();
                return;
            }
        });

        console.log('‚úÖ Event listeners configurados');
    });
</script>

{% endblock %}